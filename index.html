<!DOCTYPE html>
<html>

<head>
    <title>RC카</title>
    <script src="blockly_compressed.js"></script>
    <script src="blocks_compressed.js"></script>
    <script src="javascript_compressed.js"></script>
    <script src="msg/ko.js"></script>
    <script src="block.js"></script>
    <link href="css.css" rel="stylesheet" type="text/css">
    <style>
        #box {
            position: relative;
        }
    </style>
</head>

<body>
    <h1>RC카</h1>
    <div>
        <div id="sim">
            <div id="carsim">
                <div id="box">
                    <div id="path" class="path"></div>
                </div>
            </div>
            <div class="btnbox">
                <button onclick="runCode()" class="startbtn">코드 실행</button>
                <button onclick="reset()" class="startbtn">초기화</button>
            </div>
            <div id="outputContainer">
                <label>자바스크립트 코드</label>
                <div id="outputbox">
                    <pre id="output"></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="blocklyDiv" style="height: 600px; width: 800px; float: left;"></div>
    <xml id="toolbox" style="display: none">
        <category name="기본 블록" colour="#5C81A6">
            <block type="controls_repeat"></block>
        </category>
        <category name="RC카 블록" colour="#FF7F27">
            <block type="cfront"></block>
            <block type="cback"></block>
            <block type="crot"></block>
            <block type="crot2"></block>
            <block type="ccolor"></block>
        </category>
    </xml>
    <script>
        var box = document.getElementById('box');
        let goal;
        var codes = [];
        var ok = 0;
        let count = 0;
        let Angle = 0;

        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            trashcan: true
        });

        function runCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            document.getElementById('output').textContent = code;

            try {
                reset();
                ok = 1;
                eval(code);
                cdstart();
            } catch (error) {
                console.error("에러 코드:", error);
                alert("에러 코드:" + error);
            }
        }

        const mapArray = [
            [2, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1],
            [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
            [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 3],
            [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4],
            [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
            [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 4],
            [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
            [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
            [1, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
            [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 4],
            [1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1]
        ];

        let x = 1;
        let y = 1;
        let direction = 'right';

        function reset() {
            Angle = 0;
            count = 0;
            ok = 0;
            console.log(ok);
            codes = [];
            mapArray.length = 0;
            mapArray.push(
                [2, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1],
                [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
                [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 3],
                [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4],
                [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
                [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 4],
                [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
                [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
                [1, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
                [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 4],
                [1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1]
            );
            x = 1;
            y = 1;
            direction = 'right';
            displayMap(mapArray);
        }

        function cd(e) {
            codes.push(e);
        }

        function cdstart() {
            let delay = 0;
            console.log(codes);
            for (let i = 0; i < codes.length; i++) {
                // console.log(codes[i]);
                // console.log(ok);
                if (ok == 0) return;
                setTimeout(() => {
                    switch (codes[i]) {
                        case 1:
                            walk();
                            break;
                        case 2:
                            walk2();
                            break;
                        case 3:
                            turnRight();
                            break;
                        case 4:
                            turnLeft();
                            break;
                    }
                }, delay);
                delay += 300;
            }
        }

        function walk() {
            mapArray[y - 1][x - 1] = 0;

            if (direction === 'right' && x < mapArray[0].length)
                x += 1;
            else if (direction === 'left' && x > 1)
                x -= 1;
            else if (direction === 'up' && y > 1)
                y -= 1;
            else if (direction === 'down' && y < mapArray.length)
                y += 1;
            goal = mapArray[y - 1][x - 1];
            count++;
            mapArray[y - 1][x - 1] = 2;
            console.log(goal);
            displayMap(mapArray);
            turn(0);
        }

        function walk2() {
            mapArray[y - 1][x - 1] = 0;

            // 이동 로직
            if (direction === 'right' && x > 1)
                x -= 1;
            else if (direction === 'left' && x < mapArray[0].length)
                x += 1;
            else if (direction === 'up' && y < mapArray.length)
                y += 1;
            else if (direction === 'down' && y > 1)
                y -= 1;
            goal = mapArray[y - 1][x - 1];
            count++;
            mapArray[y - 1][x - 1] = 2;
            displayMap(mapArray);
            turn(0);
        }

        function turnRight() {
            if (direction === 'up')
                direction = 'right';
            else if (direction === 'right')
                direction = 'down';
            else if (direction === 'down')
                direction = 'left';
            else if (direction === 'left')
                direction = 'up';
            count++;
            turn(90);

        }

        function turnLeft() {
            if (direction === 'up')
                direction = 'left';
            else if (direction === 'left')
                direction = 'down';
            else if (direction === 'down')
                direction = 'right';
            else if (direction === 'right')
                direction = 'up';
            count++;
            turn(-90);
        }


        function displayMap(map) {
            const container = document.createElement('div');

            for (let i = 0; i < map.length; i++) {
                for (let j = 0; j < map[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell', `cell-${map[i][j]}`);
                    container.appendChild(cell);
                }
                container.appendChild(document.createElement('br'));
            }

            box.innerHTML = '';
            box.appendChild(container);
            if (goal == 3 && count == codes.length) {
                setTimeout(() => {
                    alert("통과");
                    goal = 1;
                    console.log("카운트 : " + count + ", " + goal);
                }, 1000);
            }
            if (goal == 4) {
                goal=1;
                alert("실패");
                reset();
            }
        }

        displayMap(mapArray);

        function turn(e) {
            Angle += e;
            const elements = document.querySelectorAll('.cell-2');
            elements.forEach(element => {
                element.style.transform = `rotate(${Angle}deg)`;
            });
        }
    </script>

</body>

</html>