<!DOCTYPE html>
<html>

<head>
    <title>RC카</title>
    <script src="blockly_compressed.js"></script>
    <script src="blocks_compressed.js"></script>
    <script src="javascript_compressed.js"></script>
    <script src="msg/ko.js"></script>
    <script src="block.js"></script>
    <link href="css.css" rel="stylesheet" type="text/css">
    <style>
        #box {
            position: relative;
        }
    </style>
</head>

<body>
    <h1>RC카</h1>
    <div>
        <div id="sim">
            <div id="carsim">
                <div id="box" style="float: left;">
                    <div id="path" class="path"></div>
                </div>
                <div>
                    <h3 style="float: right;" id="ab">0 / 4</h3>
                </div>
            </div>
            <div class="btnbox">
                <button onclick="runCode()" class="startbtn">코드 실행</button>
                <button onclick="reset()" class="startbtn">초기화</button>
            </div>
            <div id="outputContainer">
                <label>자바스크립트 코드</label>
                <div id="outputbox">
                    <pre id="output"></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="blocklyDiv" style="height: 600px; width: 800px; float: left;"></div>
    <xml id="toolbox" style="display: none">
        <category name="기본 블록" colour="#5C81A6">
            <block type="controls_repeat"></block>
        </category>
        <category name="RC카 블록" colour="#FF7F27">
            <block type="cfront"></block>
            <block type="cback"></block>
            <block type="crot"></block>
            <block type="crot2"></block>
            <block type="ccolor"></block>
        </category>
    </xml>
    <script>
        var con = document.getElementById('ab');
        var box = document.getElementById('box');
        let goal;
        var codes = [];
        var ok = 0;
        let count = 0;
        let Angle = 0;
        var repeat = 1;
        var rl = 0;
        var rbool = 0;
        var dbcode = '';
        var cnt = 0;
        var level = 1;
        var max = 5;
        var block = 0;
        const mapArray = [
            [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
            [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 3],
            [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4],
            [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
            [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 4],
            [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
            [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
            [1, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
            [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 4],
            [1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1]
        ];

        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            trashcan: true
        });
        workspace.addChangeListener(function (event) {
            if (event.type == Blockly.Events.CREATE && event.ids) {
                block += event.ids.length;
                con.innerHTML = block + " / " + max;
                if (block > max) con.style.color = "red";
                else con.style.color = "black";
            }
            else if (event.type == Blockly.Events.DELETE && event.oldXml) {
                block -= event.ids.length;
                con.innerHTML = block + " / " + max;
                if (block > max) con.style.color = "red";
                else con.style.color = "black";
            }
        });

        function runCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            document.getElementById('output').textContent = code;
            if(block > max) {
                alert("블록 갯수 초과");
                return;
            }
            try {
                reset();
                ok = 1;
                eval(code);
                cdstart();
                savecode(0, "last");
            } catch (error) {
                console.error("에러 코드:", error);
                alert("에러 코드:" + error);
            }
        }
        function savecode(e, cd, state) {
            if (e == 0) {
                // db로 보내는거
                if (dbcode.length != 0) {
                    console.log("반복 횟수" + repeat + " 코드 " + dbcode);
                    join(repeat, dbcode);
                }
                rl = 0;
                rbool = 0;
                repeat = 1;
                dbcode = '';
            } else if (cd == "rlast" && rl == 0) {
                rl = 1;
                rbool = 0;
            } else if (e == 1 && rl == 0) {
                if (isNaN(cd)) {
                    dbcode += cd;
                } else {
                    repeat = cd;
                    rbool = 1;
                }
            }
        }

        function join(r, cd) {
            cnt += 1;
            console.log("DB 넣기");
            // let formData = new FormData();
            // formData.append("order", cnt);
            // formData.append("repeat", r);
            // formData.append("code", cd);

            // // fetch('/join', { method: "POST", body: formData }).then((res) => res.json()).then((data) => {
            // //     console.log(data["msg"]);
            // });
        }

        function resetdb() {
            cnt = 0;
            console.log("DB초기화");
            // fetch('/reset', { method: "POST" }).then((res) => res.json()).then((data) => {
            //     console.log(data["msg"]);
            // });
        }

        let x = 1;
        let y = 1;
        let direction = 'right';

        function reset() {
            resetdb();
            cnt = 0;
            rl = 0;
            rbool = 0;
            repeat = 1;
            dbcode = '';
            Angle = 0;
            count = 0;
            ok = 0;
            console.log(ok);
            codes = [];
            mapArray.length = 0;
            switch (level) {
                case 1:
                    mapArray.push(
                        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
                        [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 3],
                        [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4],
                        [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
                        [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 4],
                        [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
                        [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
                        [1, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
                        [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 4],
                        [1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1]
                    );
                    max = 5;
                    con.innerHTML = block + " / " + max;
                    if (block > max) con.style.color = "red";
                    else con.style.color = "black";
                    x = 1;
                    y = 1;
                    break;
                case 2:
                    mapArray.push(
                        [1, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1],
                        [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
                        [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 2],
                        [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 1],
                        [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
                        [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 1],
                        [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
                        [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
                        [1, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
                        [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 1],
                        [1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 3]
                    );
                    max = 3;
                    con.innerHTML = block + " / " + max;
                    if (block > max) con.style.color = "red";
                    else con.style.color = "black";
                    x = 11;
                    y = 3;
                    break;
                case 3:
                    mapArray.push(
                        [1, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1],
                        [1, 4, 4, 1, 4, 4, 4, 1, 1, 4, 1],
                        [1, 4, 4, 1, 1, 1, 4, 1, 1, 4, 1],
                        [1, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4],
                        [1, 4, 1, 1, 1, 1, 4, 1, 1, 1, 1],
                        [1, 4, 1, 1, 4, 1, 4, 1, 1, 1, 4],
                        [1, 4, 1, 1, 1, 1, 1, 1, 4, 1, 1],
                        [4, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1],
                        [3, 4, 1, 4, 1, 4, 1, 1, 4, 1, 1],
                        [1, 1, 1, 4, 4, 4, 1, 4, 4, 1, 4],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2]
                    );
                    max = 7;
                    con.innerHTML = block + " / " + max;
                    if (block > max) con.style.color = "red";
                    else con.style.color = "black";
                    x = 11;
                    y = 11;
                    break;
            }
            direction = 'right';
            displayMap(mapArray);
        }

        function cd(e) {
            codes.push(e);
        }

        function cdstart() {
            let delay = 0;
            console.log(codes);
            for (let i = 0; i < codes.length; i++) {
                // console.log(codes[i]);
                // console.log(ok);
                if (ok == 0) return;
                setTimeout(() => {
                    switch (codes[i]) {
                        case 1:
                            walk();
                            break;
                        case 2:
                            walk2();
                            break;
                        case 3:
                            turnRight();
                            break;
                        case 4:
                            turnLeft();
                            break;
                    }
                }, delay);
                delay += 300;
            }
        }

        function walk() {
            mapArray[y - 1][x - 1] = 0;

            if (direction === 'right' && x < mapArray[0].length)
                x += 1;
            else if (direction === 'left' && x > 1)
                x -= 1;
            else if (direction === 'up' && y > 1)
                y -= 1;
            else if (direction === 'down' && y < mapArray.length)
                y += 1;
            goal = mapArray[y - 1][x - 1];
            count++;
            mapArray[y - 1][x - 1] = 2;
            console.log(goal);
            displayMap(mapArray);
            turn(0);
        }

        function walk2() {
            mapArray[y - 1][x - 1] = 0;

            // 이동 로직
            if (direction === 'right' && x > 1)
                x -= 1;
            else if (direction === 'left' && x < mapArray[0].length)
                x += 1;
            else if (direction === 'up' && y < mapArray.length)
                y += 1;
            else if (direction === 'down' && y > 1)
                y -= 1;
            goal = mapArray[y - 1][x - 1];
            count++;
            mapArray[y - 1][x - 1] = 2;
            displayMap(mapArray);
            turn(0);
        }

        function turnRight() {
            if (direction === 'up')
                direction = 'right';
            else if (direction === 'right')
                direction = 'down';
            else if (direction === 'down')
                direction = 'left';
            else if (direction === 'left')
                direction = 'up';
            count++;
            turn(90);

        }

        function turnLeft() {
            if (direction === 'up')
                direction = 'left';
            else if (direction === 'left')
                direction = 'down';
            else if (direction === 'down')
                direction = 'right';
            else if (direction === 'right')
                direction = 'up';
            count++;
            turn(-90);
        }


        function displayMap(map) {
            const container = document.createElement('div');

            for (let i = 0; i < map.length; i++) {
                for (let j = 0; j < map[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell', `cell-${map[i][j]}`);
                    container.appendChild(cell);
                }
                container.appendChild(document.createElement('br'));
            }

            box.innerHTML = '';
            box.appendChild(container);
            if (goal == 3 && count == codes.length) {
                setTimeout(() => {
                    alert("통과");
                    goal = 1;
                    console.log("카운트 : " + count + ", " + goal);
                    level = level + 1;
                    if (level == 4)
                        level = 1;
                    reset()
                }, 1000);
            }
            if (goal == 4) {
                goal = 1;
                alert("실패");
                reset();
            }
        }

        displayMap(mapArray);

        function turn(e) {
            Angle += e;
            const elements = document.querySelectorAll('.cell-2');
            elements.forEach(element => {
                element.style.transform = `rotate(${Angle}deg)`;
            });
        }
    </script>

</body>

</html>